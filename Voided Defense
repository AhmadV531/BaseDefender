-- Base Protector V4 - Voided Defense Edition [ULTRA OPTIMIZED]
-- Lightning-fast detection and instant command execution

if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Stats = game:GetService("Stats")

local LocalPlayer = Players.LocalPlayer
while not LocalPlayer do task.wait() LocalPlayer = Players.LocalPlayer end

-- Remote Detection - CLEAN VERSION (finds remote after DealWithThis)
local adminRemote, notificationRemote

task.spawn(function()
    local function findAdminRemote()
        local Packages = ReplicatedStorage:WaitForChild("Packages", 5)
        if not Packages then return false end
        
        local Net = Packages:WaitForChild("Net", 5)
        if not Net then return false end
        
        local children = Net:GetChildren()
        
        -- Find DealWithThis and get the remote AFTER it
        for i, obj in ipairs(children) do
            if obj:IsA("RemoteEvent") and obj.Name == "RE/AdminPanelService/DealWithThis" then
                local nextRemote = children[i + 1]
                if nextRemote and nextRemote:IsA("RemoteEvent") then
                    adminRemote = nextRemote
                    print("✅ Admin Remote Found:", nextRemote.Name)
                    return true
                end
            end
        end
        
        return false
    end
    
    -- Try to find it immediately
    if not findAdminRemote() then
        for i = 1, 60 do
            task.wait(0.5)
            if findAdminRemote() then
                break
            end
        end
    end
    
    if not adminRemote then
        warn("❌ ADMIN REMOTE NOT FOUND!")
    end
    
    -- Find notification remote
    task.wait(1)
    local Packages = ReplicatedStorage:FindFirstChild("Packages")
    if Packages then
        local Net = Packages:FindFirstChild("Net")
        if Net then
            for _, remote in ipairs(Net:GetChildren()) do
                if remote:IsA("RemoteEvent") and (remote.Name:find("Notification") or remote.Name:find("Notify")) then
                    notificationRemote = remote
                    print("✅ Notification Remote Found:", remote.Name)
                    break
                end
            end
        end
    end
end)

-- Settings
local spamNoKickEnabled = true
local antiTPEnabled = false
local cloneEspEnabled = false
local punishedPlayers = {}
local antiTPCooldowns = {}

-- Player Cache
local playerCache = {}
Players.PlayerAdded:Connect(function(p) playerCache[p.Name] = p end)
Players.PlayerRemoving:Connect(function(p) 
    playerCache[p.Name] = nil
    punishedPlayers[p.Name] = nil
    antiTPCooldowns[p.Name] = nil
end)
for _, p in ipairs(Players:GetPlayers()) do playerCache[p.Name] = p end

-- Plot Cache
local cachedPlot, cachedPlotPosition, cachedDecorations, cachedAnimals
local lastPlotCheck = 0

local function updatePlotCache()
    local plotsFolder = workspace:FindFirstChild("Plots")
    if not plotsFolder then cachedPlot = nil return end
    
    for _, plot in pairs(plotsFolder:GetChildren()) do
        local plotSign = plot:FindFirstChild("PlotSign")
        if plotSign then
            local yourBase = plotSign:FindFirstChild("YourBase")
            if yourBase and yourBase:IsA("BillboardGui") and yourBase.Enabled then
                cachedPlot = plot
                cachedPlotPosition = plot:GetPivot().Position
                cachedDecorations = plot:FindFirstChild("Decorations")
                cachedAnimals = plot:FindFirstChild("AnimalPodiums")
                lastPlotCheck = tick()
                return plot
            end
        end
    end
    
    for _, plot in pairs(plotsFolder:GetChildren()) do
        if plot.Name:find(LocalPlayer.Name) then
            cachedPlot = plot
            cachedPlotPosition = plot:GetPivot().Position
            cachedDecorations = plot:FindFirstChild("Decorations")
            cachedAnimals = plot:FindFirstChild("AnimalPodiums")
            lastPlotCheck = tick()
            return plot
        end
    end
    cachedPlot = nil
end

local function findMyPlot()
    if cachedPlot and (tick() - lastPlotCheck) < 5 then return cachedPlot end
    return updatePlotCache()
end

-- Clone ESP System
local cloneEsps = {}

local function createCloneEsp(clone)
    local username = clone.Name:match("(.+)_Clone")
    if not username then return end
    
    local head = clone:FindFirstChild("Head")
    if not head then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "CloneESP"
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 50, 0, 16)
    billboard.StudsOffset = Vector3.new(0, 1.5, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = head
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundColor3 = Color3.fromRGB(12, 15, 25)
    frame.BackgroundTransparency = 0.2
    frame.BorderSizePixel = 0
    frame.Parent = billboard
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 4)
    corner.Parent = frame
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(70, 130, 240)
    stroke.Thickness = 1
    stroke.Transparency = 0.3
    stroke.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = "CLONE"
    label.TextColor3 = Color3.fromRGB(140, 190, 255)
    label.TextSize = 7
    label.Font = Enum.Font.GothamBold
    label.TextStrokeTransparency = 0.7
    label.Parent = frame
    
    cloneEsps[clone] = billboard
    
    clone.AncestryChanged:Connect(function()
        if not clone:IsDescendantOf(workspace) and cloneEsps[clone] then
            cloneEsps[clone]:Destroy()
            cloneEsps[clone] = nil
        end
    end)
end

local function updateCloneEsps()
    if cloneEspEnabled then
        for _, obj in ipairs(workspace:GetChildren()) do
            if obj.Name:match("_Clone$") and obj:IsA("Model") and not cloneEsps[obj] then
                createCloneEsp(obj)
            end
        end
    else
        for _, esp in pairs(cloneEsps) do esp:Destroy() end
        cloneEsps = {}
    end
end

workspace.ChildAdded:Connect(function(child)
    if cloneEspEnabled and child.Name:match("_Clone$") and child:IsA("Model") then
        task.wait(0.1)
        createCloneEsp(child)
    end
end)

task.spawn(function()
    while task.wait(0.1) do
        if cloneEspEnabled then
            for _, obj in ipairs(workspace:GetChildren()) do
                if obj.Name:match("_Clone$") and obj:IsA("Model") and not cloneEsps[obj] then
                    createCloneEsp(obj)
                end
            end
        end
    end
end)

-- Helper Functions
local function sendCommand(cmd, player)
    if not adminRemote then return end
    adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", player, cmd)
end

local function getPlayersInMyPlot()
    local myPlot = cachedPlot or findMyPlot()
    if not myPlot then return {} end
    
    local players = {}
    local pos = cachedPlotPosition
    if cachedDecorations and cachedDecorations:FindFirstChild("Model") then
        pos = cachedDecorations.Model:GetPivot().Position
    end
    
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            local hrp = p.Character:FindFirstChild("HumanoidRootPart")
            if hrp and (hrp.Position - pos).Magnitude < 120 then
                table.insert(players, p)
            end
        end
    end
    return players
end

local function getNearestPlayer()
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
    
    local hrp = char.HumanoidRootPart
    local nearest, shortest = nil, math.huge
    
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            local phrp = p.Character:FindFirstChild("HumanoidRootPart")
            if phrp then
                local dist = (hrp.Position - phrp.Position).Magnitude
                if dist < shortest then
                    shortest = dist
                    nearest = p
                end
            end
        end
    end
    return nearest
end

local function getClosestPlayerToBrainrots()
    local players = getPlayersInMyPlot()
    if #players == 0 then return nil end
    
    local myPlot = cachedPlot or findMyPlot()
    if not myPlot then return nil end
    
    local closest, closestDist = nil, math.huge
    
    for _, p in ipairs(players) do
        if p.Character then
            local hrp = p.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                local minDist = math.huge
                
                if cachedDecorations and cachedDecorations:FindFirstChild("Model") then
                    minDist = (hrp.Position - cachedDecorations.Model:GetPivot().Position).Magnitude
                end
                
                if cachedAnimals then
                    for _, animal in ipairs(cachedAnimals:GetChildren()) do
                        local d = (hrp.Position - animal:GetPivot().Position).Magnitude
                        if d < minDist then minDist = d end
                    end
                end
                
                if minDist < closestDist then
                    closestDist = minDist
                    closest = p
                end
            end
        end
    end
    return closest
end

-- ⚡ ULTRA-FAST INSTANT COMMAND EXECUTION ⚡
-- Fire ALL commands simultaneously with NO delays
local function executeAPSpam(username)
    if not username or username == "" then return end
    local target = playerCache[username]
    if not target then return end
    
    -- INSTANT PARALLEL EXECUTION - All commands fire at the EXACT same time
    task.spawn(function() sendCommand("balloon", target) end)
    task.spawn(function() sendCommand("inverse", target) end)
    task.spawn(function() sendCommand("tiny", target) end)
    task.spawn(function() sendCommand("rocket", target) end)
end

local function executeDefense(name)
    if not spamNoKickEnabled then return end
    if punishedPlayers[name] then return end
    
    punishedPlayers[name] = true
    local target = playerCache[name]
    if not target then punishedPlayers[name] = nil return end
    
    executeAPSpam(name)
    task.delay(30, function() punishedPlayers[name] = nil end)
end

local function executeAntiTP(name)
    if not _G.antiTPEnabled or antiTPCooldowns[name] then return end
    antiTPCooldowns[name] = true
    
    local target = playerCache[name]
    if not target then antiTPCooldowns[name] = nil return end
    
    -- ⚡⚡⚡ INSTANT ANTI-TP EXECUTION - Fire directly with NO delays ⚡⚡⚡
    if adminRemote then
        task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "balloon") end)
        task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "jail") end)
    end
    
    task.delay(5, function() antiTPCooldowns[name] = nil end)
end

-- ⚡ ULTRA-FAST Anti-TP System - INSTANT REACTION ⚡
local function startAntiTP()
    task.spawn(function()
        task.wait(3)
        updatePlotCache()
        local detected = {}
        
        -- INSTANT DETECTION - Runs EVERY FRAME for maximum speed (60+ times per second)
        RunService.RenderStepped:Connect(function()
            if not _G.antiTPEnabled then return end
            
            for _, p in ipairs(getPlayersInMyPlot()) do
                if p.Character then
                    local hrp = p.Character:FindFirstChild("HumanoidRootPart")
                    if hrp and not detected[p.Name] then
                        local close = false
                        
                        if cachedDecorations and cachedDecorations:FindFirstChild("Model") then
                            if (hrp.Position - cachedDecorations.Model:GetPivot().Position).Magnitude < 10 then
                                close = true
                            end
                        end
                        
                        if cachedAnimals and not close then
                            for _, animal in ipairs(cachedAnimals:GetChildren()) do
                                if (hrp.Position - animal:GetPivot().Position).Magnitude < 7 then
                                    close = true
                                    break
                                end
                            end
                        end
                        
                        if close and not antiTPCooldowns[p.Name] then
                            detected[p.Name] = true
                            antiTPCooldowns[p.Name] = true
                            
                            -- ⚡⚡⚡ INSTANT FIRE - Commands execute at EXACT same time ⚡⚡⚡
                            local target = playerCache[p.Name]
                            if target and adminRemote then
                                task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "balloon") end)
                                task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "jail") end)
                            end
                            
                            task.delay(5, function() antiTPCooldowns[p.Name] = nil end)
                            task.delay(3, function() detected[p.Name] = nil end)
                        end
                    end
                end
            end
        end)
    end)
end

-- ⚡ ULTRA-OPTIMIZED BASE DEFENDER - LIGHTNING FAST DETECTION ⚡
local function startBaseDefender()
    updatePlotCache()
    
    -- Method 1: Notification Remote Detection (INSTANT)
    local function locateStealRemote()
        local packages = ReplicatedStorage:FindFirstChild("Packages")
        if not packages then return nil end
        
        local net = packages:FindFirstChild("Net")
        if not net then return nil end
        
        return net:FindFirstChild("RE/NotificationService/Notify")
    end
    
    local stealRemote
    local maxAttempts = 10
    for i = 1, maxAttempts do
        stealRemote = locateStealRemote()
        if stealRemote then
            break
        end
        task.wait(0.5)
    end
    
    if stealRemote then
        stealRemote.OnClientEvent:Connect(function(msg)
            if typeof(msg) ~= "string" then return end
            if not spamNoKickEnabled then return end
            if not msg:find("Someone is stealing your") then return end
            
            -- ⚡⚡⚡ INSTANT RESPONSE - ALL commands fire at EXACT same time ⚡⚡⚡
            local players = getPlayersInMyPlot()
            if #players > 0 and not punishedPlayers[players[1].Name] then
                local targetName = players[1].Name
                punishedPlayers[targetName] = true
                
                local target = playerCache[targetName]
                if target and adminRemote then
                    task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "balloon") end)
                    task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "inverse") end)
                    task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "tiny") end)
                    task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "rocket") end)
                end
                
                task.delay(30, function() punishedPlayers[targetName] = nil end)
            end
        end)
    end
    
    -- ⚡ Method 2: HYPER-OPTIMIZED GUI TEXT DETECTION ⚡
    -- Uses DUAL detection: GetPropertyChangedSignal + RenderStepped for 100% reliability
    local gui = LocalPlayer:WaitForChild("PlayerGui")
    local tracked = {}
    
    -- Simplified pattern matching - just look for key words
    local function hasStealPattern(text)
        local lower = string.lower(text)
        return string.find(lower, "steal", 1, true) or 
               string.find(lower, "rob", 1, true) or
               string.find(lower, "taking", 1, true)
    end
    
    -- Cache GUI descendants for faster scanning
    local cachedGuiElements = {}
    
    local function updateGuiCache()
        cachedGuiElements = {}
        for _, g in ipairs(gui:GetDescendants()) do
            if (g:IsA("TextLabel") or g:IsA("TextButton")) then
                table.insert(cachedGuiElements, g)
            end
        end
    end
    
    -- Function to execute commands INSTANTLY - all at once
    local function fireCommands(targetName)
        if punishedPlayers[targetName] then return end
        punishedPlayers[targetName] = true
        
        local target = playerCache[targetName]
        if target and adminRemote then
            -- Fire ALL commands at the EXACT SAME TIME
            task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "balloon") end)
            task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "inverse") end)
            task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "tiny") end)
            task.spawn(function() adminRemote:FireServer("78a772b6-9e1c-4827-ab8b-04a07838f298", target, "rocket") end)
        end
        
        task.delay(30, function() punishedPlayers[targetName] = nil end)
    end
    
    -- Initial cache
    updateGuiCache()
    
    -- Method A: GetPropertyChangedSignal for existing elements
    for _, element in ipairs(cachedGuiElements) do
        element:GetPropertyChangedSignal("Text"):Connect(function()
            if not spamNoKickEnabled or tracked[element] then return end
            if not element.Visible or element.Text == "" then return end
            
            if hasStealPattern(element.Text) then
                tracked[element] = true
                
                local players = getPlayersInMyPlot()
                if #players > 0 then
                    fireCommands(players[1].Name)
                end
                
                task.delay(0.1, function() tracked[element] = nil end)
            end
        end)
        
        element:GetPropertyChangedSignal("Visible"):Connect(function()
            if not spamNoKickEnabled or tracked[element] then return end
            if not element.Visible or element.Text == "" then return end
            
            if hasStealPattern(element.Text) then
                tracked[element] = true
                
                local players = getPlayersInMyPlot()
                if #players > 0 then
                    fireCommands(players[1].Name)
                end
                
                task.delay(0.1, function() tracked[element] = nil end)
            end
        end)
    end
    
    -- Method B: Real-time detection for NEW GUI elements
    gui.DescendantAdded:Connect(function(descendant)
        if (descendant:IsA("TextLabel") or descendant:IsA("TextButton")) then
            table.insert(cachedGuiElements, descendant)
            
            descendant:GetPropertyChangedSignal("Text"):Connect(function()
                if not spamNoKickEnabled or tracked[descendant] then return end
                if not descendant.Visible or descendant.Text == "" then return end
                
                if hasStealPattern(descendant.Text) then
                    tracked[descendant] = true
                    
                    local players = getPlayersInMyPlot()
                    if #players > 0 then
                        fireCommands(players[1].Name)
                    end
                    
                    task.delay(0.1, function() tracked[descendant] = nil end)
                end
            end)
            
            descendant:GetPropertyChangedSignal("Visible"):Connect(function()
                if not spamNoKickEnabled or tracked[descendant] then return end
                if not descendant.Visible or descendant.Text == "" then return end
                
                if hasStealPattern(descendant.Text) then
                    tracked[descendant] = true
                    
                    local players = getPlayersInMyPlot()
                    if #players > 0 then
                        fireCommands(players[1].Name)
                    end
                    
                    task.delay(0.1, function() tracked[descendant] = nil end)
                end
            end)
        end
    end)
    
    gui.DescendantRemoving:Connect(function(descendant)
        for i, element in ipairs(cachedGuiElements) do
            if element == descendant then
                table.remove(cachedGuiElements, i)
                break
            end
        end
    end)
    
    -- Method C: RenderStepped BACKUP (ultra-fast scanning)
    RunService.RenderStepped:Connect(function()
        if not spamNoKickEnabled then return end
        
        for _, g in ipairs(cachedGuiElements) do
            if g.Visible and g.Text ~= "" and not tracked[g] then
                if hasStealPattern(g.Text) then
                    tracked[g] = true
                    
                    local players = getPlayersInMyPlot()
                    if #players > 0 then
                        fireCommands(players[1].Name)
                    end
                    
                    task.delay(0.1, function() tracked[g] = nil end)
                end
            end
        end
    end)
end

-- ============================================
-- VOIDED DEFENSE GUI
-- ============================================

local sg = Instance.new("ScreenGui")
sg.Name = "BaseProtector"
sg.ResetOnSpawn = false
sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
sg.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Main Frame
local main = Instance.new("Frame")
main.Size = UDim2.new(0, 190, 0, 240)
main.Position = UDim2.new(0, 20, 0.5, -120)
main.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
main.BackgroundTransparency = 0.35
main.BorderSizePixel = 0
main.Active = true
main.Draggable = true
main.Parent = sg

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 16)
mainCorner.Parent = main

local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(80, 140, 220)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 80, 160))
}
gradient.Rotation = 135
gradient.Parent = main

local glow = Instance.new("UIStroke")
glow.Color = Color3.fromRGB(120, 180, 255)
glow.Thickness = 2
glow.Transparency = 0.4
glow.Parent = main

task.spawn(function()
    while glow.Parent do
        TweenService:Create(glow, TweenInfo.new(2, Enum.EasingStyle.Sine), {Transparency = 0.2}):Play()
        task.wait(2)
        if not glow.Parent then break end
        TweenService:Create(glow, TweenInfo.new(2, Enum.EasingStyle.Sine), {Transparency = 0.6}):Play()
        task.wait(2)
    end
end)

-- Title (full width now)
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -50, 0, 45)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "VOIDED DEFENSE"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 15
title.Font = Enum.Font.GothamBold
title.TextXAlignment = Enum.TextXAlignment.Left
title.TextYAlignment = Enum.TextYAlignment.Center
title.Parent = main

local titleGlow = Instance.new("UIStroke")
titleGlow.Color = Color3.fromRGB(150, 200, 255)
titleGlow.Thickness = 1
titleGlow.Transparency = 0.5
titleGlow.Parent = title

-- Performance stats (just text, no background)
local stats = Instance.new("TextLabel")
stats.Size = UDim2.new(0, 100, 0, 35)
stats.Position = UDim2.new(0.5, -50, 0, 25)
stats.BackgroundTransparency = 1
stats.Text = "FPS: 60\nPing: 0ms"
stats.TextColor3 = Color3.fromRGB(255, 255, 255)
stats.TextSize = 10
stats.Font = Enum.Font.GothamBold
stats.TextXAlignment = Enum.TextXAlignment.Center
stats.TextYAlignment = Enum.TextYAlignment.Center
stats.Parent = sg

local statsGlow = Instance.new("UIStroke")
statsGlow.Color = Color3.fromRGB(150, 200, 255)
statsGlow.Thickness = 1
statsGlow.Transparency = 0.3
statsGlow.Parent = stats

-- Update stats with REAL network ping
task.spawn(function()
    local lastUpdate = tick()
    local frameCount = 0
    
    RunService.RenderStepped:Connect(function()
        frameCount = frameCount + 1
    end)
    
    while stats.Parent do
        task.wait(0.01)
        
        local now = tick()
        local delta = now - lastUpdate
        
        if delta >= 0.01 then
            local fps = math.floor(frameCount / delta)
            frameCount = 0
            lastUpdate = now
            
            -- Get REAL Roblox network ping (divide by 2 for one-way latency)
            local ping = 0
            pcall(function()
                local dataPing = Stats.Network.ServerStatsItem["Data Ping"]:GetValue()
                ping = math.floor(dataPing / 2)
            end)
            
            stats.Text = string.format("FPS: %d\nPing: %dms", fps, ping)
        end
    end
end)

-- Animated title colors
task.spawn(function()
    while titleGlow.Parent do
        TweenService:Create(title, TweenInfo.new(1.5, Enum.EasingStyle.Sine), {
            TextColor3 = Color3.fromRGB(150, 210, 255)
        }):Play()
        TweenService:Create(titleGlow, TweenInfo.new(1.5, Enum.EasingStyle.Sine), {
            Color = Color3.fromRGB(100, 180, 255), Transparency = 0.2
        }):Play()
        task.wait(1.5)
        if not titleGlow.Parent then break end
        
        TweenService:Create(title, TweenInfo.new(1.5, Enum.EasingStyle.Sine), {
            TextColor3 = Color3.fromRGB(80, 140, 220)
        }):Play()
        TweenService:Create(titleGlow, TweenInfo.new(1.5, Enum.EasingStyle.Sine), {
            Color = Color3.fromRGB(40, 100, 180), Transparency = 0.7
        }):Play()
        task.wait(1.5)
        if not titleGlow.Parent then break end
        
        TweenService:Create(title, TweenInfo.new(1.5, Enum.EasingStyle.Sine), {
            TextColor3 = Color3.fromRGB(255, 255, 255)
        }):Play()
        TweenService:Create(titleGlow, TweenInfo.new(1.5, Enum.EasingStyle.Sine), {
            Color = Color3.fromRGB(150, 200, 255), Transparency = 0.5
        }):Play()
        task.wait(1.5)
    end
end)

-- Minimize button
local minBtn = Instance.new("TextButton")
minBtn.Size = UDim2.new(0, 30, 0, 30)
minBtn.Position = UDim2.new(1, -38, 0, 10)
minBtn.BackgroundColor3 = Color3.fromRGB(40, 80, 160)
minBtn.BackgroundTransparency = 0.3
minBtn.Text = "─"
minBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
minBtn.TextSize = 18
minBtn.Font = Enum.Font.GothamBold
minBtn.BorderSizePixel = 0
minBtn.Parent = main

local minCorner = Instance.new("UICorner")
minCorner.CornerRadius = UDim.new(1, 0)
minCorner.Parent = minBtn

-- Content area
local content = Instance.new("Frame")
content.Size = UDim2.new(1, -20, 1, -58)
content.Position = UDim2.new(0, 10, 0, 50)
content.BackgroundTransparency = 1
content.Parent = main

-- Toggle function
local function createToggle(text, yPos, default)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, 36)
    container.Position = UDim2.new(0, 0, 0, yPos)
    container.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    container.BackgroundTransparency = 0.75
    container.BorderSizePixel = 0
    container.Parent = content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = container
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(150, 200, 255)
    stroke.Thickness = 1.5
    stroke.Transparency = 0.5
    stroke.Parent = container
    
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, 0, 1, 0)
    btn.BackgroundTransparency = 1
    btn.Text = ""
    btn.Parent = container
    
    local lbl = Instance.new("TextLabel")
    lbl.Size = UDim2.new(1, -65, 1, 0)
    lbl.Position = UDim2.new(0, 10, 0, 0)
    lbl.BackgroundTransparency = 1
    lbl.Text = text
    lbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    lbl.TextSize = 12
    lbl.Font = Enum.Font.GothamBold
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.Parent = container
    
    local switchBg = Instance.new("Frame")
    switchBg.Size = UDim2.new(0, 45, 0, 22)
    switchBg.Position = UDim2.new(1, -52, 0.5, -11)
    switchBg.BackgroundColor3 = default and Color3.fromRGB(100, 200, 120) or Color3.fromRGB(160, 170, 180)
    switchBg.BorderSizePixel = 0
    switchBg.Parent = container
    
    local switchCorner = Instance.new("UICorner")
    switchCorner.CornerRadius = UDim.new(1, 0)
    switchCorner.Parent = switchBg
    
    local switchCircle = Instance.new("Frame")
    switchCircle.Size = UDim2.new(0, 18, 0, 18)
    switchCircle.Position = default and UDim2.new(1, -20, 0.5, -9) or UDim2.new(0, 2, 0.5, -9)
    switchCircle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    switchCircle.BorderSizePixel = 0
    switchCircle.Parent = switchBg
    
    local circleCorner = Instance.new("UICorner")
    circleCorner.CornerRadius = UDim.new(1, 0)
    circleCorner.Parent = switchCircle
    
    return btn, switchBg, switchCircle
end

-- Create toggles
local autoBtn, autoSwitch, autoCircle = createToggle("Auto Defense", 0, spamNoKickEnabled)
local tpBtn, tpSwitch, tpCircle = createToggle("Anti-TP", 50, antiTPEnabled)
local espBtn, espSwitch, espCircle = createToggle("Clone ESP", 100, cloneEspEnabled)

-- Toggle handlers
autoBtn.MouseButton1Click:Connect(function()
    _G.spamNoKickEnabled = not _G.spamNoKickEnabled
    spamNoKickEnabled = _G.spamNoKickEnabled
    TweenService:Create(autoSwitch, TweenInfo.new(0.2), {
        BackgroundColor3 = spamNoKickEnabled and Color3.fromRGB(100, 200, 120) or Color3.fromRGB(160, 170, 180)
    }):Play()
    TweenService:Create(autoCircle, TweenInfo.new(0.2), {
        Position = spamNoKickEnabled and UDim2.new(1, -20, 0.5, -9) or UDim2.new(0, 2, 0.5, -9)
    }):Play()
end)

tpBtn.MouseButton1Click:Connect(function()
    _G.antiTPEnabled = not _G.antiTPEnabled
    antiTPEnabled = _G.antiTPEnabled
    TweenService:Create(tpSwitch, TweenInfo.new(0.2), {
        BackgroundColor3 = antiTPEnabled and Color3.fromRGB(100, 200, 120) or Color3.fromRGB(160, 170, 180)
    }):Play()
    TweenService:Create(tpCircle, TweenInfo.new(0.2), {
        Position = antiTPEnabled and UDim2.new(1, -20, 0.5, -9) or UDim2.new(0, 2, 0.5, -9)
    }):Play()
end)

espBtn.MouseButton1Click:Connect(function()
    _G.cloneEspEnabled = not _G.cloneEspEnabled
    cloneEspEnabled = _G.cloneEspEnabled
    TweenService:Create(espSwitch, TweenInfo.new(0.2), {
        BackgroundColor3 = cloneEspEnabled and Color3.fromRGB(100, 200, 120) or Color3.fromRGB(160, 170, 180)
    }):Play()
    TweenService:Create(espCircle, TweenInfo.new(0.2), {
        Position = cloneEspEnabled and UDim2.new(1, -20, 0.5, -9) or UDim2.new(0, 2, 0.5, -9)
    }):Play()
    updateCloneEsps()
end)

-- Spam button
local spamFrame = Instance.new("Frame")
spamFrame.Size = UDim2.new(0, 160, 0, 55)
spamFrame.Position = UDim2.new(1, -180, 0.5, -27)
spamFrame.BackgroundTransparency = 1
spamFrame.Active = true
spamFrame.Draggable = true
spamFrame.Parent = sg

local spamBtn = Instance.new("TextButton")
spamBtn.Size = UDim2.new(1, 0, 1, 0)
spamBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
spamBtn.BackgroundTransparency = 0.3
spamBtn.Text = "EXECUTE (F)"
spamBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
spamBtn.TextSize = 18
spamBtn.Font = Enum.Font.GothamBold
spamBtn.BorderSizePixel = 0
spamBtn.Parent = spamFrame

local spamCorner = Instance.new("UICorner")
spamCorner.CornerRadius = UDim.new(0, 14)
spamCorner.Parent = spamBtn

local spamGradient = Instance.new("UIGradient")
spamGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(80, 140, 220)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 80, 160))
}
spamGradient.Rotation = 135
spamGradient.Parent = spamBtn

local spamGlow = Instance.new("UIStroke")
spamGlow.Color = Color3.fromRGB(120, 180, 255)
spamGlow.Thickness = 2
spamGlow.Transparency = 0.4
spamGlow.Parent = spamBtn

task.spawn(function()
    while spamGlow.Parent do
        TweenService:Create(spamGlow, TweenInfo.new(2, Enum.EasingStyle.Sine), {Transparency = 0.2}):Play()
        task.wait(2)
        if not spamGlow.Parent then break end
        TweenService:Create(spamGlow, TweenInfo.new(2, Enum.EasingStyle.Sine), {Transparency = 0.6}):Play()
        task.wait(2)
    end
end)

spamBtn.MouseEnter:Connect(function()
    TweenService:Create(spamBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.15}):Play()
end)

spamBtn.MouseLeave:Connect(function()
    TweenService:Create(spamBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.3}):Play()
end)

local function executeSpam()
    local totalOtherPlayers = #Players:GetPlayers() - 1
    
    if totalOtherPlayers == 2 then
        local allPlayers = {}
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= LocalPlayer then table.insert(allPlayers, p) end
        end
        
        if #allPlayers == 2 then
            local p1, p2 = allPlayers[1], allPlayers[2]
            local d1, d2 = math.huge, math.huge
            
            if p1.Character and p1.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = p1.Character.HumanoidRootPart
                if cachedDecorations and cachedDecorations:FindFirstChild("Model") then
                    d1 = (hrp.Position - cachedDecorations.Model:GetPivot().Position).Magnitude
                end
                if cachedAnimals then
                    for _, a in ipairs(cachedAnimals:GetChildren()) do
                        local d = (hrp.Position - a:GetPivot().Position).Magnitude
                        if d < d1 then d1 = d end
                    end
                end
            end
            
            if p2.Character and p2.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = p2.Character.HumanoidRootPart
                if cachedDecorations and cachedDecorations:FindFirstChild("Model") then
                    d2 = (hrp.Position - cachedDecorations.Model:GetPivot().Position).Magnitude
                end
                if cachedAnimals then
                    for _, a in ipairs(cachedAnimals:GetChildren()) do
                        local d = (hrp.Position - a:GetPivot().Position).Magnitude
                        if d < d2 then d2 = d end
                    end
                end
            end
            
            local closestToBrainrot = d1 < d2 and p1 or p2
            local farthest = d1 < d2 and p2 or p1
            
            if closestToBrainrot then
                task.spawn(function() sendCommand("balloon", closestToBrainrot) end)
                task.spawn(function() sendCommand("inverse", closestToBrainrot) end)
                task.spawn(function() sendCommand("tiny", closestToBrainrot) end)
                task.spawn(function() sendCommand("rocket", closestToBrainrot) end)
            end
            
            if farthest then
                task.spawn(function() sendCommand("morph", farthest) end)
                task.spawn(function() sendCommand("jumpscare", farthest) end)
                task.spawn(function() sendCommand("ragdoll", farthest) end)
                task.spawn(function() sendCommand("jail", farthest) end)
            end
            
            TweenService:Create(spamBtn, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(100, 240, 140)}):Play()
            task.wait(0.1)
            TweenService:Create(spamBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 120, 200)}):Play()
            return
        end
    end
    
    local target = getNearestPlayer()
    if target then
        executeAPSpam(target.Name)
        TweenService:Create(spamBtn, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(100, 240, 140)}):Play()
        task.wait(0.1)
        TweenService:Create(spamBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 120, 200)}):Play()
    end
end

spamBtn.MouseButton1Click:Connect(executeSpam)

UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.F then
        executeSpam()
    end
end)

-- Minimize
local isMinimized = false
minBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    if isMinimized then
        TweenService:Create(main, TweenInfo.new(0.3, Enum.EasingStyle.Quint), {Size = UDim2.new(0, 190, 0, 40)}):Play()
        content.Visible = false
        minBtn.Text = "+"
    else
        TweenService:Create(main, TweenInfo.new(0.3, Enum.EasingStyle.Quint), {Size = UDim2.new(0, 190, 0, 240)}):Play()
        task.wait(0.2)
        content.Visible = true
        minBtn.Text = "─"
    end
end)

-- Initialize
_G.spamNoKickEnabled = spamNoKickEnabled
_G.antiTPEnabled = antiTPEnabled
_G.cloneEspEnabled = cloneEspEnabled

task.spawn(function()
    local waited = 0
    while not adminRemote and waited < 15 do
        task.wait(0.5)
        waited = waited + 0.5
    end
    if adminRemote then
        updatePlotCache()
        startBaseDefender()
        startAntiTP()
    end
end)
